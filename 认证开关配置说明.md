# 认证开关配置说明

## 功能概述

AI智能助手现在支持可配置的认证开关，提供两种登录方式：

1. **企业微信OAuth2.0登录** - 显示真实用户名和头像
2. **用户名密码登录** - 显示用户名和默认头像

## 认证开关

### ENABLE_AUTH 环境变量

- `ENABLE_AUTH=true` - 启用认证（默认）
- `ENABLE_AUTH=false` - 关闭认证，直接访问

## 认证配置

### 用户名密码配置

```bash
# 支持多用户，格式：用户名:密码,用户名:密码
BASIC_AUTH_USERS=admin:admin123,user1:pass123,user2:pass456
```

### 企业微信配置（可选）

```bash
WEWORK_CORP_ID=your_corp_id
WEWORK_AGENT_ID=your_agent_id  
WEWORK_CORP_SECRET=your_corp_secret
WEWORK_REDIRECT_URI=https://your-domain.com/
```

## 认证流程

### 认证开启时（ENABLE_AUTH=true）

```
用户访问 → 检查是否已登录
         ↓
    已登录（有token）？
         ↓        ↓
        是        否
         ↓        ↓
      进入应用   显示登录页面
                  ↓
             两个登录选项：
             1. 用户名密码登录（始终可用）
             2. 企业微信登录（如果配置了）
```

### 认证关闭时（ENABLE_AUTH=false）

```
用户访问 → 直接进入应用（无需认证）
```

## 用户信息显示

| 登录方式 | 用户名 | 头像 |
|---------|-------|------|
| 企业微信 | 真实姓名 | 企业微信头像URL |
| 用户名密码 | 用户名 | 默认头像（User图标） |

## 配置示例

### 生产环境（启用认证+企业微信）

```bash
ENABLE_AUTH=true
BASIC_AUTH_USERS=admin:admin123,user1:pass123
WEWORK_CORP_ID=YOUR_WEWORK_CORP_ID_HERE
WEWORK_AGENT_ID=YOUR_WEWORK_AGENT_ID_HERE
WEWORK_CORP_SECRET=***
WEWORK_REDIRECT_URI=https://your-domain.com/auth/callback
JWT_SECRET=***
```

### 开发环境（仅密码登录）

```bash
ENABLE_AUTH=true
BASIC_AUTH_USERS=dev:dev123
```

### 测试环境（关闭认证）

```bash
ENABLE_AUTH=false
```

## Docker Compose 配置

### docker-compose.yml

```yaml
environment:
  # 认证开关和用户配置
  - ENABLE_AUTH=${ENABLE_AUTH:-true}
  - BASIC_AUTH_USERS=${BASIC_AUTH_USERS:-admin:admin123}
  
  # 企业微信认证配置（可选）
  - WEWORK_CORP_ID=${WEWORK_CORP_ID}
  - WEWORK_AGENT_ID=${WEWORK_AGENT_ID}
  - WEWORK_CORP_SECRET=${WEWORK_CORP_SECRET}
  - WEWORK_REDIRECT_URI=${WEWORK_REDIRECT_URI}
  
  # JWT配置
  - JWT_SECRET=${JWT_SECRET}
```

## API 端点

### 认证相关

- `POST /api/auth/login` - 用户名密码登录
- `GET /api/auth/config` - 获取认证配置
- `GET /api/auth/wework/redirect` - 企业微信登录重定向
- `GET /api/auth/wework/callback` - 企业微信回调
- `GET /api/auth/userinfo` - 获取用户信息
- `POST /api/auth/logout` - 退出登录

### 认证配置响应

```json
{
  "authEnabled": true,
  "weworkEnabled": true,
  "availableUsers": ["admin", "user1"]
}
```

## 安全考虑

1. **密码安全** - 密码不在前端验证，全部后端验证
2. **JWT安全** - token包含登录方式标识，24小时过期
3. **多用户支持** - 环境变量支持多用户配置
4. **认证开关** - `ENABLE_AUTH=false` 仅用于开发/测试环境

## 部署检查清单

- [ ] 设置 `ENABLE_AUTH` 环境变量
- [ ] 配置 `BASIC_AUTH_USERS`（如果启用认证）
- [ ] 配置企业微信参数（如果需要企业微信登录）
- [ ] 设置 `JWT_SECRET`（生产环境必须更改）
- [ ] 测试用户名密码登录
- [ ] 测试企业微信登录（如果配置）
- [ ] 测试认证开关关闭功能

## 故障排除

### 常见问题

1. **登录失败**
   - 检查用户名密码是否正确
   - 检查 `BASIC_AUTH_USERS` 格式
   - 查看服务器日志

2. **企业微信登录失败**
   - 检查企业微信配置参数
   - 检查回调URL配置
   - 确认企业微信应用权限

3. **认证开关不生效**
   - 检查 `ENABLE_AUTH` 环境变量
   - 重启容器
   - 检查环境变量是否生效

### 日志关键词

- `[认证]` - 认证相关日志
- `[认证开关]` - 认证开关相关日志
- `[认证上下文]` - 前端认证上下文日志
- `[登录组件]` - 登录组件相关日志
