# 部署检查清单

## ✅ 已完成配置

### 1. 代码安全性
- ✅ `docker-compose.yml` - 使用环境变量占位符
- ✅ `docker-compose.prod.yml` - 使用环境变量占位符  
- ✅ `.gitignore` - 已配置忽略 `.env` 等敏感文件
- ✅ 文档中使用示例配置

### 2. 进程管理
- ✅ PM2 已安装并配置
- ✅ `ecosystem.config.js` - PM2配置文件
- ✅ 自动重启、日志管理已配置

### 3. 企业微信认证
- ✅ 后端API已集成
- ✅ 前端登录流程已实现
- ✅ JWT认证已配置

---

## 🚀 部署前准备

### 步骤1：在服务器设置环境变量

```bash
# 方式A：导出环境变量
export WEWORK_CORP_ID="ww34c4b3d2116ec846"
export WEWORK_AGENT_ID="1000031"
export WEWORK_CORP_SECRET="EML-6zPzfrf08auXwA5BSbjh7vOiDD-5OZ9OCBWTPl0"
export WEWORK_REDIRECT_URI="https://xzs.myships.com/"
export JWT_SECRET="mJIFc33EI6dSHfmZ"

# 方式B：或创建 .env 文件（已在.gitignore中，不会提交）
cat > .env << EOF
WEWORK_CORP_ID=ww34c4b3d2116ec846
WEWORK_AGENT_ID=1000031
WEWORK_CORP_SECRET=EML-6zPzfrf08auXwA5BSbjh7vOiDD-5OZ9OCBWTPl0
WEWORK_REDIRECT_URI=https://xzs.myships.com/
JWT_SECRET=mJIFc33EI6dSHfmZ
EOF
```

### 步骤2：确认企业微信后台配置

登录 https://work.weixin.qq.com/ 确认：

- [ ] 应用 AgentID `1000031` 存在
- [ ] 可信域名已添加：`xzs.myships.com`
- [ ] 应用可见范围已设置

### 步骤3：构建镜像

```bash
cd /home/ubuntu/project/gjxt-oa/ai-chat-frontend
docker build -t land007/ai-chat-app .
```

### 步骤4：启动服务

```bash
# 生产环境
docker-compose -f docker-compose.prod.yml up -d

# 查看日志
docker logs -f ai-chat-app-prod
```

### 步骤5：验证部署

```bash
# 1. 检查健康状态
curl http://localhost:3000/api/health

# 2. 检查环境变量
docker exec ai-chat-app-prod printenv | grep WEWORK

# 3. 访问应用
# 浏览器打开: https://xzs.myships.com
```

---

## 📋 Git提交检查

### 可以安全提交的文件：
```bash
✅ docker-compose.yml              # 使用环境变量占位符
✅ docker-compose.prod.yml         # 使用环境变量占位符
✅ .gitignore                      # 已配置
✅ server.js                       # 后端代码
✅ src/                            # 前端代码
✅ ecosystem.config.js             # PM2配置
✅ package.json                    # 依赖配置
✅ Dockerfile                      # Docker配置
✅ *.md                           # 文档文件
```

### 不会被提交的文件（.gitignore已配置）：
```bash
❌ .env                           # 包含真实密钥
❌ .env.production                # 包含真实密钥
❌ logs/                          # 日志文件
❌ node_modules/                  # 依赖包
❌ build/                         # 构建产物
```

---

## 🔍 部署后检查

### 1. 服务状态
```bash
docker ps | grep ai-chat-app
docker logs ai-chat-app-prod --tail 50
```

### 2. PM2状态
```bash
docker exec ai-chat-app-prod pm2 status
```

### 3. 测试认证流程
1. 访问 https://xzs.myships.com
2. 应该显示登录页面
3. 点击"使用企业微信登录"
4. 跳转到企业微信授权页面
5. 授权后应显示主应用

### 4. 测试API
```bash
# 无需认证的API
curl https://xzs.myships.com/api/health
curl https://xzs.myships.com/api/auth/wework/redirect

# 需要认证的API（需要token）
curl -H "Authorization: Bearer YOUR_TOKEN" \
     https://xzs.myships.com/api/config
```

---

## ⚠️ 安全提醒

1. ✅ **环境变量** - 已配置为占位符，可安全提交
2. ✅ **密钥管理** - 真实密钥通过环境变量传入，不在代码中
3. ✅ **文件保护** - `.env` 文件已在 `.gitignore` 中
4. ✅ **文档安全** - 文档中使用示例配置

---

## 📚 相关文档

- `环境变量配置说明.md` - 详细的环境变量配置指南
- `PM2使用指南.md` - PM2进程管理使用说明
- `WEWORK_AUTH_README.md` - 企业微信认证集成文档

---

## 🎯 快速命令参考

```bash
# 停止旧服务
docker-compose down

# 启动新服务（生产）
docker-compose -f docker-compose.prod.yml up -d

# 查看日志
docker logs -f ai-chat-app-prod

# 重启服务
docker-compose -f docker-compose.prod.yml restart

# 查看PM2状态
docker exec ai-chat-app-prod pm2 status

# 查看PM2日志
docker exec ai-chat-app-prod pm2 logs
```

---

## ✨ 完成！

所有配置已完成，代码可以安全提交到Git仓库。部署时只需在服务器设置环境变量即可。

