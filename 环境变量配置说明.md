# 环境变量配置说明

## 部署前必须配置

部署应用前，需要在服务器上设置以下环境变量：

### 方法1：在服务器上导出环境变量（推荐）

```bash
# 企业微信认证配置
export WEWORK_CORP_ID="ww34c4b3d2116ec846"
export WEWORK_AGENT_ID="1000031"
export WEWORK_CORP_SECRET="EML-6zPzfrf08auXwA5BSbjh7vOiDD-5OZ9OCBWTPl0"
export WEWORK_REDIRECT_URI="https://xzs.myships.com/"
export JWT_SECRET="mJIFc33EI6dSHfmZ"

# 阿里云配置（如果有）
export DASHSCOPE_API_KEY="your_actual_api_key"
export DASHSCOPE_API_URL="your_actual_api_url"

# 然后启动Docker
docker-compose -f docker-compose.prod.yml up -d
```

### 方法2：创建.env文件（本地开发）

在项目根目录创建 `.env` 文件：

```bash
# 企业微信认证配置
WEWORK_CORP_ID=ww34c4b3d2116ec846
WEWORK_AGENT_ID=1000031
WEWORK_CORP_SECRET=EML-6zPzfrf08auXwA5BSbjh7vOiDD-5OZ9OCBWTPl0
WEWORK_REDIRECT_URI=https://xzs.myships.com/
JWT_SECRET=mJIFc33EI6dSHfmZ

# 阿里云配置
DASHSCOPE_API_KEY=your_actual_api_key
DASHSCOPE_API_URL=your_actual_api_url
```

然后启动：
```bash
docker-compose -f docker-compose.prod.yml up -d
```

Docker Compose会自动读取 `.env` 文件中的变量。

### 方法3：直接在docker-compose命令中指定

```bash
WEWORK_CORP_ID=ww34c4b3d2116ec846 \
WEWORK_AGENT_ID=1000031 \
WEWORK_CORP_SECRET=EML-6zPzfrf08auXwA5BSbjh7vOiDD-5OZ9OCBWTPl0 \
WEWORK_REDIRECT_URI=https://xzs.myships.com/ \
JWT_SECRET=mJIFc33EI6dSHfmZ \
docker-compose -f docker-compose.prod.yml up -d
```

## 环境变量说明

| 变量名 | 必需 | 说明 | 示例值 |
|--------|------|------|--------|
| `WEWORK_CORP_ID` | ✅ | 企业微信企业ID | ww34c4b3d2116ec846 |
| `WEWORK_AGENT_ID` | ✅ | 企业微信应用AgentID | 1000031 |
| `WEWORK_CORP_SECRET` | ✅ | 企业微信应用Secret | EML-6zPz... |
| `WEWORK_REDIRECT_URI` | ✅ | OAuth回调地址 | https://xzs.myships.com/ |
| `JWT_SECRET` | ✅ | JWT签名密钥 | mJIFc33EI6dSHfmZ |
| `DASHSCOPE_API_KEY` | ⚠️ | 阿里云API密钥 | sk-xxx... |
| `DASHSCOPE_API_URL` | ⚠️ | 阿里云API地址 | https://... |

## 安全注意事项

⚠️ **重要**：
1. ✅ `.env` 文件已在 `.gitignore` 中，不会被提交到Git
2. ✅ `docker-compose.yml` 文件使用环境变量占位符，可以安全提交
3. ❌ 不要将真实的密钥直接写在 `docker-compose.yml` 中
4. ❌ 不要将 `.env` 文件提交到代码仓库

## 快速部署脚本

创建一个部署脚本 `deploy-prod.sh`：

```bash
#!/bin/bash

# 设置环境变量
export WEWORK_CORP_ID="ww34c4b3d2116ec846"
export WEWORK_AGENT_ID="1000031"
export WEWORK_CORP_SECRET="EML-6zPzfrf08auXwA5BSbjh7vOiDD-5OZ9OCBWTPl0"
export WEWORK_REDIRECT_URI="https://xzs.myships.com/"
export JWT_SECRET="mJIFc33EI6dSHfmZ"

# 构建并启动
docker-compose -f docker-compose.prod.yml up -d --build

echo "✅ 部署完成！"
echo "📡 访问地址: https://xzs.myships.com"
```

赋予执行权限并运行：
```bash
chmod +x deploy-prod.sh
./deploy-prod.sh
```

## 验证配置

启动容器后，检查环境变量是否正确加载：

```bash
# 查看容器环境变量
docker exec ai-chat-app-prod printenv | grep WEWORK

# 测试API
curl http://localhost:3000/api/health
```

## 故障排除

### 问题：环境变量未生效

**症状**：容器启动后提示"企业微信配置不完整"

**解决**：
```bash
# 1. 确认环境变量已设置
echo $WEWORK_CORP_ID

# 2. 重新启动容器
docker-compose -f docker-compose.prod.yml down
docker-compose -f docker-compose.prod.yml up -d

# 3. 检查容器内的环境变量
docker exec ai-chat-app-prod env | grep WEWORK
```

