# 企业微信配置检查指南

## 🔍 问题：redirect_uri需要使用应用可信域名

### 错误原因
企业微信OAuth2.0要求 `redirect_uri` 必须使用**应用可信域名**，这是安全限制。

## ✅ 解决步骤

### 1. 检查企业微信后台配置

#### 登录企业微信管理后台
1. 访问：https://work.weixin.qq.com/
2. 使用管理员账号登录
3. 进入 **应用管理**

#### 找到你的应用
1. 在应用列表中找到你的应用（AgentID: YOUR_WEWORK_AGENT_ID_HERE）
2. 点击应用名称进入详情

#### 检查可信域名配置
1. 找到 **可信域名** 设置
2. 确保 `your-domain.com` 已添加到可信域名列表
3. 如果没有，点击 **添加域名** 并输入 `your-domain.com`

### 2. 修正 redirect_uri 配置

#### 正确的配置格式
```bash
# ✅ 正确：指向具体的回调路径
WEWORK_REDIRECT_URI=https://your-domain.com/auth/callback

# ❌ 错误：指向根路径
WEWORK_REDIRECT_URI=https://your-domain.com/
```

#### 为什么需要具体路径？
- 企业微信要求 `redirect_uri` 必须是**完整的回调URL**
- 不能只是域名，需要包含具体的回调路径
- 我们的应用使用 `/auth/callback` 作为回调路径

### 3. 验证配置

#### 检查当前配置
```bash
# 查看环境变量
echo $WEWORK_REDIRECT_URI

# 应该显示：
# https://your-domain.com/auth/callback
```

#### 测试企业微信登录
1. 访问应用：https://your-domain.com/
2. 点击 **使用企业微信登录**
3. 应该能正常跳转到企业微信授权页面
4. 授权后应该能正常回调到应用

## 🚨 常见问题

### 问题1：域名未添加到可信域名
**错误信息**：`redirect_uri域名与后台配置不一致`

**解决方案**：
1. 在企业微信后台添加 `your-domain.com` 到可信域名
2. 等待5-10分钟生效

### 问题2：redirect_uri格式错误
**错误信息**：`redirect_uri参数错误`

**解决方案**：
1. 确保使用完整URL：`https://your-domain.com/auth/callback`
2. 不要使用根路径：`https://your-domain.com/`

### 问题3：IP白名单限制
**错误信息**：`not allow to access from your ip, hint: [xxxxx], from ip: xxx.xxx.xxx.xxx`

**解决方案**：
1. 登录企业微信管理后台：https://work.weixin.qq.com/
2. 进入 **应用管理** → 找到您的应用
3. 找到 **IP白名单** 或 **可信IP** 设置
4. 添加服务器IP地址到白名单
5. 保存配置并等待生效

**获取服务器IP方法**：
```bash
# 方法1：使用curl
curl -s ifconfig.me

# 方法2：使用ipinfo
curl -s ipinfo.io/ip

# 方法3：查看服务器外网IP
curl -s ipinfo.io/ip
```

**IP白名单配置建议**：
- 添加当前服务器IP：`YOUR_SERVER_IP_HERE`
- 如果使用CDN，也需要添加CDN IP段
- 建议配置IP段而不是单个IP，如：`YOUR_IP_RANGE/24`

### 问题4：HTTPS证书问题
**错误信息**：`证书验证失败`

**解决方案**：
1. 确保域名使用有效的HTTPS证书
2. 检查证书是否过期
3. 确保证书链完整

## 📋 配置检查清单

- [ ] 企业微信后台已添加 `your-domain.com` 到可信域名
- [ ] `WEWORK_REDIRECT_URI` 配置为 `https://your-domain.com/auth/callback`
- [ ] 服务器IP已添加到企业微信IP白名单
- [ ] 域名使用有效的HTTPS证书
- [ ] 应用能正常访问 `https://your-domain.com/`
- [ ] 企业微信登录按钮能正常跳转
- [ ] 授权后能正常回调到应用

## 🔧 环境变量配置

### 生产环境
```bash
export WEWORK_CORP_ID="YOUR_WEWORK_CORP_ID_HERE"
export WEWORK_AGENT_ID="YOUR_WEWORK_AGENT_ID_HERE"
export WEWORK_CORP_SECRET="YOUR_WEWORK_CORP_SECRET_HERE"
export WEWORK_REDIRECT_URI="https://your-domain.com/auth/callback"
export JWT_SECRET="YOUR_JWT_SECRET_HERE"
```

### Docker Compose
```yaml
environment:
  - WEWORK_CORP_ID=${WEWORK_CORP_ID}
  - WEWORK_AGENT_ID=${WEWORK_AGENT_ID}
  - WEWORK_CORP_SECRET=${WEWORK_CORP_SECRET}
  - WEWORK_REDIRECT_URI=${WEWORK_REDIRECT_URI}
  - JWT_SECRET=${JWT_SECRET}
```

## 📞 技术支持

如果问题仍然存在，请检查：
1. 企业微信后台的可信域名配置
2. 域名DNS解析是否正确
3. HTTPS证书是否有效
4. 应用是否正常运行

## 🔗 相关链接

- [企业微信OAuth2.0文档](https://developer.work.weixin.qq.com/document/path/91022)
- [企业微信应用管理](https://work.weixin.qq.com/wework_admin/frame#apps)
- [企业微信可信域名配置](https://developer.work.weixin.qq.com/document/path/91120)
